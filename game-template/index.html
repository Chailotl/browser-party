<div id="joinScreen">
	<label for="nameInput">Name</label><br>
	<input id="nameInput" placeholder="Enter your name" oninput="updateButtons()">
	<br><br>
	<button class="roomBtn" disabled onclick="createRoom()">Create Room</button>
	<button class="roomBtn" disabled onclick="joinRoom()">Join Room</button>
</div>

<div id="roomScreen" style="display: none">
	<b id="roomCode"></b>
	<pre id="playerList"></pre>
	<button onclick="readyUp()">Ready Up</button>
	<button disabled onclick="">Start Game</button>
	<br><br>
	<input id="chatInput" onkeypress="sendChatMessage(event)">
	<div id="chatOutput"></div>
</div>

<div id="gameScreen" style="display: none">

</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
	var screens = {
		join: document.getElementById('joinScreen'),
		room: document.getElementById('roomScreen'),
		game: document.getElementById('gameScreen')
	}

	var nameInput = document.getElementById('nameInput');
	var roomButtons = document.querySelectorAll('.roomBtn');

	var roomCodeDiv = document.getElementById('roomCode');
	var playerList = document.getElementById('playerList');
	var chatOutput = document.getElementById('chatOutput');
	var chatInput = document.getElementById('chatInput');

	var socket = io('ws://localhost:22222');

	var game = 'spyfall';
	var players = [];
	var player = undefined;

	// Joined the room
	socket.on('joinedRoom', arg =>
	{
		roomCodeDiv.innerText = arg.code;
		screens.join.style.display = 'none';
		screens.room.style.display = '';

		initGame();

		players = arg.players;
		players.forEach(ply => initPlayer());
		updatePlayerList();
	});

	// Denied joining room
	socket.on('kicked', arg =>
	{
		playerList = [];
		player = undefined;
		updatePlayerList();
		alert(arg);
	});

	// A player joined the room
	socket.on('playerJoin', arg =>
	{
		initPlayer(arg);
		players.push(arg);
		updatePlayerList();
	});

	// A player left the room, so remove them from the list
	socket.on('playerLeave', arg =>
	{
		players = players.filter(ply => ply.id != arg);
		updatePlayerList();
	});

	// A player renamed themselves
	socket.on('playerRename', arg =>
	{
		players.map(ply =>
		{
			if (ply.id == arg.id)
			{
				ply.name = arg.name;
			}
		});
		updatePlayerList();
	});

	// New player is the host
	socket.on('playerHost', arg =>
	{
		players.map(ply =>
		{
			ply.host = ply.id == arg;
		});
		updatePlayerList();
	});

	// Data received from host
	socket.on('receive', arg =>
	{
		console.log(arg);

		if (player.host)
		{
			switch (arg.ev)
			{
				case 'ready':
					sendAll('ready', { id: arg.id, state: arg.data });
					break;
			}
		}
		else
		{
			switch (arg.ev)
			{
				case 'ready':

					break;
			}
		}
	});

	// Chat messages received from any player
	socket.on('chat', arg =>
	{
		chatOutput.innerText += arg + '\n';
	});

	// This will initialize the game state
	function initGame()
	{
		game.location = '';
		game.role = '';
	}

	// This will initialize a player
	function initPlayer(ply)
	{
		ply.readyUp = false;
	}

	function send(event, data, id = undefined)
	{
		socket.emit('send', { ev: event, data: data, id: id });
	}

	function sendAll(event, data)
	{
		if (player.host)
		{
			socket.emit('sendAll', { ev: event, data: data });
		}
	}

	function updateButtons()
	{
		var nameless = nameInput.value == '';
		roomButtons.forEach(btn => btn.disabled = nameless);
	}

	function createRoom()
	{
		socket.emit('createRoom', { game: game, name: nameInput.value });
	}

	function joinRoom()
	{
		var roomCode = window.prompt('Enter 4-letter room code').toUpperCase();

		socket.emit('joinRoom', { game: game, code: roomCode, name: nameInput.value });
	}

	function updatePlayerList()
	{
		var str = '';

		players.forEach(ply =>
		{
			str += (ply.host ? '* ' : '  ') + ply.name + '\n';

			// Find myself
			if (ply.id == socket.id)
			{
				player = ply;
			}
		});

		playerList.innerText = str;
	}

	function sendChatMessage(event)
	{
		if (event.keyCode == 13)
		{
			chatOutput.innerText = nameInput.value + ': ' + chatInput.value + '\n' + chatOutput.innerText;
			socket.emit('chat', chatInput.value);
			chatInput.value = '';
		}
	}

	function readyUp()
	{
		send('ready', true);
	}
</script>